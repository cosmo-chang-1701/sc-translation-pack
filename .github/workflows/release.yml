name: Auto Release and Discord Notify

on:
  push:
    tags:
      - 'v*.*.*-v*'

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    environment: Prod
    permissions:
      contents: write

    steps:
      - name: æª¢å‡ºå„²å­˜åº«ä»£ç¢¼
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: å–å¾—ç‰ˆæœ¬è™Ÿèˆ‡æ ¼å¼åŒ–æ—¥æœŸ
        id: vars
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "GAME_VERSION=${VERSION%%-*}" >> $GITHUB_OUTPUT
          # è¨­å®šå°åŒ—æ™‚é–“ (UTC+8)
          echo "DATE=$(TZ='Asia/Taipei' date +'%Y-%m-%d %H:%M')" >> $GITHUB_OUTPUT

      - name: å–å¾—å‰ä¸€ç‰ˆæœ¬èˆ‡æ¯”å°é€£çµ
        id: diff
        run: |
          # å–å¾—ç•¶å‰ Tag ä¹‹å‰çš„æœ€æ–°ä¸€å€‹ Tag
          # ä½¿ç”¨ git tag åˆ—è¡¨æ‰¾å‡ºå‰ä¸€å€‹ç‰ˆæœ¬
          PREV_TAG=$(git tag --list 'v*' --sort=-v:refname --merged HEAD | sed -n '2p')

          if [ -z "$PREV_TAG" ]; then
            echo "æ²’æœ‰æ‰¾åˆ°å‰ä¸€å€‹ç‰ˆæœ¬ï¼Œè·³éæ¯”å°é€£çµã€‚"
            echo "HAS_PREV=false" >> $GITHUB_OUTPUT
          else
            echo "æ‰¾åˆ°å‰ä¸€ç‰ˆæœ¬: $PREV_TAG"
            echo "PREV_TAG=$PREV_TAG" >> $GITHUB_OUTPUT
            echo "HAS_PREV=true" >> $GITHUB_OUTPUT
            # ç”¢ç”Ÿ GitHub æ¯”å°é€£çµ
            echo "COMPARE_URL=https://github.com/${{ github.repository }}/compare/$PREV_TAG...${{ steps.vars.outputs.VERSION }}" >> $GITHUB_OUTPUT
          fi

      - name: æ‰“åŒ…ç¿»è­¯æª” (ZIP)
        run: |
          # æ‰“åŒ…ç¹é«”ä¸­æ–‡è³‡æ–™å¤¾
          zip -r "sc-localization-zh-TW-${{ steps.vars.outputs.VERSION }}.zip" "./chinese_(traditional)/"

      - name: å»ºç«‹ GitHub Release
        id: create_release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.vars.outputs.VERSION }}
          name: "Release ${{ steps.vars.outputs.VERSION }}"
          generate_release_notes: true
          body: |
            ## æ˜Ÿéš›å…¬æ°‘éå®˜æ–¹å¤šåœ‹èªç³»æ›´æ–°
            - **ç™¼å¸ƒæ—¥æœŸ**: ${{ steps.vars.outputs.DATE }} (å°åŒ—æ™‚é–“)
            - **ç‰ˆæœ¬è™Ÿ**: ${{ steps.vars.outputs.VERSION }}
            - **å°æ‡‰éŠæˆ²ç‰ˆæœ¬**: ${{ steps.vars.outputs.GAME_VERSION }}

            ## èªç³»æª”èªªæ˜
            zh-TW: ç¹é«”ä¸­æ–‡
            
            *æ­¤ç‰ˆæœ¬ç”± GitHub Actions è‡ªå‹•ç”Ÿæˆä¸¦æ‰“åŒ…ç™¼å¸ƒã€‚*
          files: |
            sc-localization-zh-TW-${{ steps.vars.outputs.VERSION }}.zip

      - name: Discord é€šçŸ¥
        uses: sarisia/actions-status-discord@v1
        if: success()
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
          color: 0x00ff00
          username: "ç¿»è­¯æ›´æ–°ç™¼ä½ˆåŠ©æ‰‹"
          content: "<@&${{ secrets.DISCORD_ROLE_ID }}>"
          title: "ğŸš€ æ˜Ÿéš›å…¬æ°‘éå®˜æ–¹å¤šåœ‹èªç³»æ›´æ–°ï¼š${{ steps.vars.outputs.VERSION }}"
          description: |
            æœ€æ–°çš„æ˜Ÿéš›å…¬æ°‘éå®˜æ–¹å¤šåœ‹èªç³»å·²ç¶“ç™¼å¸ƒï¼
            
            ğŸ“… **ç™¼å¸ƒæ—¥æœŸ**: ${{ steps.vars.outputs.DATE }} (å°åŒ—æ™‚é–“)
            ğŸ“¦ **ç‰ˆæœ¬è™Ÿ**: ${{ steps.vars.outputs.VERSION }}
            ğŸ® **å°æ‡‰éŠæˆ²ç‰ˆæœ¬**: ${{ steps.vars.outputs.GAME_VERSION }}

            èªç³»æª”èªªæ˜
            zh-TW: ç¹é«”ä¸­æ–‡

            ${{ steps.diff.outputs.HAS_PREV == 'true' && format('ğŸ” [**æŸ¥çœ‹èˆ‡å‰ç‰ˆ {0} çš„å·®ç•°æ¯”å°**]({1})', steps.diff.outputs.PREV_TAG, steps.diff.outputs.COMPARE_URL) || '' }}
            
            [ğŸ‘‰ å‰å¾€ GitHub ä¸‹è¼‰æœ€æ–°ç¿»è­¯](https://github.com/${{ github.repository }}/releases/latest)